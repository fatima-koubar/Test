import { computed, inject, Injectable, signal } from '@angular/core';
import { ApiCallerService, ApiUrlService } from '../../core';
import { map, Observable } from 'rxjs';
import { MerchantValidationRequest } from '../models/merchant-validation-request.model';
import { ApplePayDTO } from './dtos/apple-pay.dto';
import { MerchantVerificationDTO } from './dtos/merchant-verification.dto';
import { validateApplePayDTO, validateMerchantVerificationDTO } from './validators';

const merchantverificationPath = '/applepay/merchantverification';

@Injectable({
  providedIn: 'root',
})
export class ApplePayApi {
  private readonly _apiCallerService = inject(ApiCallerService);
  private readonly _apiUrlService = inject(ApiUrlService);
  private readonly _apiBaseUrl = signal<string>(this._apiUrlService.apiUrl());
  private readonly collectionSessionHref = signal<string>('');

  private readonly sessionEndpoint = computed(
    () => `${this._apiBaseUrl()}${this.collectionSessionHref()}`,
  );

  public setCollectionSessionHref(href: string): void {
    return this.collectionSessionHref.set(href);
  }

  public getCollectionSessionData(): Observable<ApplePayDTO> {
    return this._apiCallerService.get(this.sessionEndpoint()).pipe(
      map((raw) => {
        validateApplePayDTO(raw);
        return raw;
      }),
    );
  }

  public putToken(token: string): Observable<void> {
    return this._apiCallerService
      .put(`${this.sessionEndpoint()}/token`, { token: token })
      .pipe(map(() => {}));
  }

  public merchantVerification(
    merchantValidationRequest: MerchantValidationRequest,
  ): Observable<MerchantVerificationDTO> | never {
    return this._apiCallerService
      .post(
        'https://' + window.location.hostname + merchantverificationPath,
        JSON.stringify(merchantValidationRequest),
      )
      .pipe(
        map((raw) => {
          validateMerchantVerificationDTO(raw);
          return raw;
        }),
      );
  }
}
