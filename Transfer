import { inject, Injectable } from '@angular/core';
import { HateoasPaymentMeanApplePay, PAYMENT_MEAN_TYPES, WINDOW } from '../../../public-api';
import { RessourceLoaderService } from '../../core/services/ressource-loader.service';
import { PaymentSessionDTO } from '../../router/api/dtos/payment-session.dto';

@Injectable({
  providedIn: 'root',
})
export abstract class ApplePayAdapterService {
  private readonly APPLE_PAY_SDK_URL =
    'https://applepay.cdn-apple.com/jsapi/v1.3.2/apple-pay-sdk.js';
  private readonly INTEGRITY_HASH =
    'sha384-DZRWMZLyVXr+7shJfal8pIG2v4KisLoSWFjZQMUv0+GWaCwoa82qeHsWrbBIUDPU';

  private readonly _window = inject(WINDOW);
  private readonly _ressourceLoader = inject(RessourceLoaderService);

  public abstract setSession(session: any): void;
  public abstract startTransaction(): void;

  async applePayLoadScript(rawData: PaymentSessionDTO): Promise<void> {
    const applePayPaymentMean = rawData._links.payment_means?.filter(
      (pm: any) => pm.type === PAYMENT_MEAN_TYPES.APPLEPAY,
    );
    if (applePayPaymentMean && applePayPaymentMean.length > 0) {
      this.loadScript();
      if (!rawData.sandbox && (window as any).ApplePaySession) {
        const merchantIdentifier = (applePayPaymentMean[0] as HateoasPaymentMeanApplePay)
          .merchantIdentifier;
        const ApplePaySession = (window as any).ApplePaySession;
        const capabilities = await ApplePaySession.applePayCapabilities(merchantIdentifier);
        switch (capabilities.paymentCredentialStatus) {
          case 'applePayUnsupported':
            rawData._links.payment_means = rawData._links.payment_means?.filter(
              (pm: any) => pm.type !== PAYMENT_MEAN_TYPES.APPLEPAY,
            );
        }
      }
    }
  }

  canApplePayPayment(): boolean {
    return (
      Boolean(this._ressourceLoader.getLoadedResource(this.APPLE_PAY_SDK_URL)) &&
      (this._window as any).ApplePaySession.canMakePayments()
    );
  }

  loadScript(): void {
    try {
      this._ressourceLoader.loadScript(this.APPLE_PAY_SDK_URL, {
        integrity: this.INTEGRITY_HASH,
        crossOrigin: 'anonymous',
      });
    } catch (error) {
      throw new Error((error as Error).message);
    }
  }
}
