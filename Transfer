import { from, Observable } from 'rxjs';

checkout(): Observable<CheckoutOutput> {
  const isMobile = this._breakpointObserver.isMatched(MOBILE_BREAKPOINT);

  const dialogRef = this._dialog.open<
    ApplePayTestCardsComponent,
    unknown,
    TestCard | undefined
  >(ApplePayTestCardsComponent, {
    panelClass: isMobile
      ? [MOBILE_DIALOG_CLASS, DESKTOP_DIALOG_CLASS]
      : MOBILE_DIALOG_CLASS,
  });

  // Wrap an async function in `from` to return Observable
  return from(
    (async () => {
      const testCard = await firstValueFrom(dialogRef.afterClosed());

      if (!testCard) {
        throw new Error(
          'ApplePaySandboxSDKAdapter | startTransaction | Carte sélectionnée inexistante'
        );
      }

      return {
        token: btoa(
          JSON.stringify({
            account_number: testCard.account_number,
            expiration_date: TestCardsService.getTwoYearsFromNowFormattedDate(),
            cvx: '666',
            holder_name: 'John Doe',
            scheme: testCard.scheme,
          })
        ),
      } as CheckoutOutput;
    })()
  );
}


checkout(): Observable<CheckoutOutput> {
    return this._applePayAdapter.checkout().pipe(
      switchMap((output) => {
        if (output) {
          this._applePaySessionBuilderService.putToken(output.token);
        }
        return of(output);
      }),
    );
  }
