import { inject, Injectable, signal, ViewContainerRef } from '@angular/core';
import { TestCard } from '../../card/models/test-card';
import { ApplePaySessionPayload } from '../models/apple-pay-session-payload.model';
import { APPLE_PAY_ADAPTER } from '../injection-tokens/apple-pay-adapters.injection-token';
import { ApplePaySessionBuilderService } from '../adapters/implementations/live/apple-pay-session-builder.service';
import { ApplePayService } from './apple-pay.service';

@Injectable({ providedIn: 'root' })
export class ApplePayFlowService {
  testCards = signal<TestCard[]>([]);

  private brandList: string[] = [];
  private countryCode = '';
  private merchantName = '';
  private amount = '';
  private payload!: ApplePaySessionPayload;
  private container!: ViewContainerRef;
  private onClose?: () => void;

  private readonly _applePayService = inject(ApplePayService);
  private readonly _applePaySessionBuilderService = inject(ApplePaySessionBuilderService);
  private readonly _applePayAdapter = inject(APPLE_PAY_ADAPTER);

  setContainer(container: ViewContainerRef): void {
    this.container = container;
  }

  setCloseEvent(callback: () => void): void {
    this.onClose = callback;
  }

  async init(): Promise<void> {
    const data = await this._applePayService.getCollectionSessionData();

    this.brandList = data.brandList;
    this.testCards.set(data.testCards);
    this.countryCode = data.countryCode;
    this.merchantName = data.merchantName;
    this.amount = data.amount;
    this.payload = data.payload;
  }

  startTransaction(): void {
    const session = this._applePaySessionBuilderService.createSession({
      countryCode: this.countryCode,
      brandList: this.brandList,
      merchantName: this.merchantName,
      amount: this.amount,
      payload: this.payload,
      container: this.container,
      onCancel: this.onClose,
    });

    this._applePayAdapter.setSession(session);
    this._applePayAdapter.startTransaction();
  }
}
